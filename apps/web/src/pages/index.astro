---
import { inlineCSS } from "../styles/inline.css.ts";
import Toast from "../components/Toast.astro";
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>sakla — Taktik kısa bağlantıları saniyeler içinde oluşturun</title>
    <meta
      name="description"
      content="sakla, Cloudflare Pages için D1 kalıcılığı, KV önbelleği ve kuyruk destekli analizlerle taktik bir URL kısaltıcıdır."
    />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style set:html={inlineCSS} is:global></style>
  </head>
  <body>
    <div class="page">
      <nav class="nav">
        <a href="/" class="logo" title="Ana sayfaya git">sakla</a>
        <div class="nav-actions">
          <a class="nav-link" href="/admin" title="Yönetim paneline git">Yönetim</a>
        </div>
      </nav>

      <main class="main-content">
        <div class="hero-section">
          <span class="hero-badge">kısa. akıllı. senin.</span>
          <h1 class="hero-title">Kısa bağlantıları anında oluşturun</h1>
          <p class="hero-subtitle">Her URL'yi saniyeler içinde temiz ve paylaşılabilir bir bağlantıya dönüştürün</p>
        </div>

        <div class="content-grid">
          <form id="create-form" class="form-card" method="post" action="/api/links" onsubmit="return false;">
            <div class="form-field">
              <label for="target" class="field-label">
                Hedef URL <span class="required">*</span>
              </label>
              <input 
                id="target" 
                name="target" 
                type="url" 
                required 
                placeholder="https://example.com" 
                class="field-input"
              />
            </div>

            <div class="form-row">
              <div class="form-field">
                <label for="alias" class="field-label">
                  Özel Kısaltma <span class="optional">isteğe bağlı</span>
                </label>
                <input
                  id="alias"
                  name="alias"
                  type="text"
                  pattern="[a-zA-Z0-9-_]+"
                  placeholder="my-link"
                  class="field-input field-input-mono"
                />
              </div>
              
              <div class="form-field">
                <label for="expiresAt" class="field-label">
                  Son Kullanım <span class="optional">isteğe bağlı</span>
                </label>
                <input 
                  id="expiresAt" 
                  name="expiresAt" 
                  type="datetime-local" 
                  class="field-input"
                />
              </div>
            </div>

            <button type="submit" class="submit-button">
              <span class="material-icons button-icon">add_link</span>
              <span>Bağlantı oluştur</span>
              <span id="submit-spinner" class="material-icons button-spinner" style="display:none;">hourglass_empty</span>
            </button>
            
            <p id="form-status" class="form-status"></p>
          </form>

          <div id="result-card" class="result-card" data-state="empty">
            <div id="result-placeholder" class="result-placeholder">
              <span class="material-icons placeholder-icon">link</span>
              <p class="placeholder-text">Oluşturduğunuz bağlantı burada görünecek</p>
            </div>
            
            <div id="result-detail" class="result-content" style="display:none;">
              <div class="result-header">
                <span class="material-icons result-icon">check_circle</span>
                <h3 class="result-title">Bağlantı oluşturuldu</h3>
              </div>
              
              <div class="result-url-wrapper">
                <a 
                  id="result-url" 
                  href="#" 
                  target="_blank" 
                  rel="noopener" 
                  class="result-url"
                  title="Kısa bağlantıyı yeni sekmede aç"
                ></a>
              </div>
              
              <div class="result-buttons">
                <button id="copy-link" type="button" class="result-btn result-btn-primary">
                  <span class="material-icons">content_copy</span>
                  Bağlantıyı kopyala
                </button>
                <a 
                  id="qr-link" 
                  href="#" 
                  target="_blank" 
                  rel="noopener"
                  class="result-btn result-btn-secondary"
                  title="Bu bağlantı için QR kodunu görüntüle"
                >
                  <span class="material-icons">qr_code</span>
                  QR kodunu gör
                </a>
              </div>

              <div class="result-details">
                <div class="detail-item">
                  <span class="detail-label">Kısaltma</span>
                  <code id="result-alias" class="detail-value detail-code"></code>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Hedef</span>
                  <span id="result-target" class="detail-value detail-target"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Sona erme</span>
                  <span id="result-expires" class="detail-value"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <section class="bookmarklet-section">
        <div class="bookmarklet-card">
          <div class="bookmarklet-header">
            <span class="material-icons bookmarklet-icon" aria-hidden="true">auto_awesome</span>
            <div>
              <h2 class="bookmarklet-title">Yer İmi Aracı</h2>
              <p class="bookmarklet-subtitle">Bulunduğunuz sayfayı ayrılmadan kısaltın</p>
            </div>
          </div>
          <p class="bookmarklet-copy">
            Aşağıdaki düğmeyi yer imi çubuğunuza sürükleyin. Herhangi bir sitede tıkladığınızda sakla açılır ve bulunduğunuz sayfa için kısa bağlantı oluşturur.
          </p>
          <a id="bookmarklet-link" class="bookmarklet-button" href="#" draggable="true">
            <span class="material-icons">bolt</span>
            <span>sakla ile kısalt</span>
          </a>
          <p class="bookmarklet-hint">İpucu: Mobilde butonu favorilerinize ekleyerek elinizin altında tutabilirsiniz.</p>
        </div>
      </section>
    </div>

    <Toast />

    <script is:inline>
      console.log('Script loading...');
      (function() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
        
        function init() {
          console.log('DOM loaded');
          const form = document.getElementById('create-form');
          if (!form) {
            console.error('Form not found!');
            return;
          }
          console.log('Form found');
          
          const status = document.getElementById('form-status');
          const spinner = document.getElementById('submit-spinner');
          const detail = document.getElementById('result-detail');
          const card = document.getElementById('result-card');
          const urlAnchor = document.getElementById('result-url');
          const aliasEl = document.getElementById('result-alias');
          const targetEl = document.getElementById('result-target');
          const expiresEl = document.getElementById('result-expires');
          const copyButton = document.getElementById('copy-link');
          const qrLink = document.getElementById('qr-link');
          const bookmarkletLink = document.getElementById('bookmarklet-link');

          console.log('All elements found');

          form.addEventListener('submit', function(e) {
            console.log('SUBMIT EVENT!');
            e.preventDefault();
            e.stopPropagation();
            handleSubmit(e);
            return false;
          });
          
          if (copyButton) {
            copyButton.addEventListener('click', handleCopy);
          }

          if (bookmarkletLink) {
            initializeBookmarklet(bookmarkletLink);
          }

          function initializeBookmarklet(link) {
            try {
              const origin = window.location.origin;
              const isLocal = /^https?:\/\/(localhost|127(?:\.\d+){3})(:\d+)?$/.test(origin);
              const bookmarkletOrigin = isLocal ? origin : "https://sakla.dev";
              const escapedOrigin = bookmarkletOrigin.replace(/'/g, "\\'");
              const bookmarklet = "javascript:(()=>{const base='" + escapedOrigin
                + "';const target=encodeURIComponent(location.href);const win=window.open(base + '/bookmarklet?target=' + target,'_blank');if(win){win.opener=null;}})();";
              link.href = bookmarklet;
            } catch (error) {
              console.error('Failed to set bookmarklet:', error);
              link.removeAttribute('href');
              link.setAttribute('aria-disabled', 'true');
            }
          }

          async function handleSubmit(event) {
            console.log('handleSubmit called', event);
            let formEl = event.target || form;
            
            if (!(formEl instanceof HTMLFormElement)) {
              formEl = document.getElementById('create-form');
              if (!formEl || !(formEl instanceof HTMLFormElement)) {
                console.error('Form element not found');
                setStatus('Error: Form not found');
                return;
              }
            }
            
            console.log('Processing form submission');
            const formData = new FormData(formEl);
            const target = formData.get('target');
            console.log('Target URL:', target);
            
            if (typeof target !== 'string' || target.length === 0) {
              console.log('Target URL is empty');
              setStatus('Hedef URL gerekli.');
              return;
            }
            const alias = formData.get('alias');
            const expiresAt = formData.get('expiresAt');
            const payload = {
              target,
              alias: typeof alias === 'string' && alias.length > 0 ? alias : undefined,
              expiresAt: typeof expiresAt === 'string' && expiresAt.length > 0 ? new Date(expiresAt).toISOString() : undefined,
            };

            console.log('Payload:', payload);
            setSubmitting(true);
            
            try {
              console.log('Sending request to /api/links');
              const response = await fetch('/api/links', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify(payload),
              });

              console.log('Response status:', response.status);
              const result = await response.json();
              console.log('Create link response:', result);
              
              if (!response.ok) {
                const message = typeof result?.error === 'string' ? result.error : 'Failed to create link';
                setStatus(message.replace(/_/g, ' '));
                return;
              }

              if (!result || !result.alias) {
                console.error('Invalid response:', result);
              setStatus('Sunucudan geçersiz yanıt.');
                return;
              }

              const aliasValue = result.alias;
              const shortUrl = new URL(aliasValue, window.location.origin).toString();
              console.log('Short URL:', shortUrl);
              
              if (urlAnchor) {
                urlAnchor.textContent = shortUrl;
                urlAnchor.href = shortUrl;
                console.log('Updated URL anchor');
              }
              if (aliasEl) {
                aliasEl.textContent = aliasValue;
                console.log('Updated alias:', aliasValue);
              }
              if (targetEl) {
                targetEl.textContent = payload.target;
                console.log('Updated target:', payload.target);
              }
              if (expiresEl) {
                if (payload.expiresAt) {
                  const expiresDate = new Date(payload.expiresAt);
                  expiresEl.textContent = expiresDate.toLocaleString();
                } else {
                  expiresEl.textContent = 'Süresiz';
                }
              }
              if (qrLink) {
                qrLink.href = '/qr/' + aliasValue;
              }
              
              const placeholder = document.getElementById('result-placeholder');
              if (placeholder) {
                placeholder.style.display = 'none';
                console.log('Hiding placeholder');
              }
              
              if (detail) {
                detail.style.display = '';
                detail.removeAttribute('style');
                console.log('Showing result detail');
              }
              if (card) {
                card.dataset.state = 'ready';
                console.log('Card state set to ready');
              }
              
              setStatus('Bağlantı başarıyla oluşturuldu!');
              if (formEl) formEl.reset();
            } catch (error) {
              console.error('Error:', error);
              setStatus('Beklenmeyen bir hata oluştu. Tekrar deneyin.');
            } finally {
              setSubmitting(false);
            }
          }

          function setSubmitting(value) {
            const submit = form.querySelector('button[type="submit"]');
            if (submit instanceof HTMLButtonElement) {
              submit.disabled = value;
              if (value) {
                submit.classList.add('submitting');
              } else {
                submit.classList.remove('submitting');
              }
            }
            if (spinner) spinner.style.display = value ? 'inline-block' : 'none';
          }

          function setStatus(message) {
            if (status) {
              const translated = translateMessage(message);
              status.textContent = translated;
              const normalized = translated.toLowerCase();
              const isError =
                normalized.includes('error') ||
                normalized.includes('hata') ||
                normalized.includes('failed') ||
                normalized.includes('başarısız');
              status.className = isError ? 'form-status form-status-error' : 'form-status';
            }
          }

          function translateMessage(input) {
            const key = (input || '').toString().trim().toLowerCase();
            const map = new Map([
              ['target url is required.', 'Hedef URL gerekli.'],
              ['invalid response from server.', 'Sunucudan geçersiz yanıt.'],
              ['link created successfully!', 'Bağlantı başarıyla oluşturuldu!'],
              ['unexpected error. try again.', 'Beklenmeyen bir hata oluştu. Tekrar deneyin.'],
              ['failed to create link', 'Bağlantı oluşturulamadı'],
              ['invalid target', 'Geçersiz hedef'],
              ['alias taken', 'Kısaltma zaten kullanımda'],
              ['alias unavailable', 'Kısaltma kullanılamıyor'],
              ['turnstile verification failed', 'Turnstile doğrulaması başarısız oldu'],
              ['rate limit exceeded', 'İstek sınırı aşıldı'],
              ['short link copied', 'Kısa bağlantı kopyalandı'],
              ['copy failed', 'Kopyalama başarısız'],
              ['error: form not found', 'Hata: Form bulunamadı'],
              ['invalid response from server.', 'Sunucudan geçersiz yanıt.'],
              ['invalid response from server', 'Sunucudan geçersiz yanıt'],
            ]);
            return map.get(key) ?? input;
          }

          async function handleCopy() {
            if (!urlAnchor) return;
            const href = urlAnchor.href;
            try {
              await navigator.clipboard.writeText(href);
              if (copyButton) {
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = '<span class="material-icons">check</span> Kopyalandı!';
                setTimeout(() => {
                  copyButton.innerHTML = originalText;
                }, 2000);
              }
              window.dispatchEvent(
                new CustomEvent('toast', { detail: { message: 'Kısa bağlantı kopyalandı' } }),
              );
            } catch (error) {
              console.error('Copy failed', error);
              window.dispatchEvent(
                new CustomEvent('toast', { detail: { message: 'Kopyalama başarısız' } }),
              );
            }
          }
        }
      })();
      console.log('Script setup complete');
    </script>
  </body>
</html>

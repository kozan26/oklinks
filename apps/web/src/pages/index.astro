---
// Build trigger
import { inlineCSS } from "../styles/inline.css.ts";
import Toast from "../components/Toast.astro";
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>sakla â€” Taktik kÄ±sa baÄŸlantÄ±larÄ± saniyeler iÃ§inde oluÅŸturun</title>
    <meta
      name="description"
      content="sakla, Cloudflare Pages iÃ§in D1 kalÄ±cÄ±lÄ±ÄŸÄ±, KV Ã¶nbelleÄŸi ve kuyruk destekli analizlerle taktik bir URL kÄ±saltÄ±cÄ±dÄ±r."
    />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”—</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style set:html={inlineCSS} is:global></style>
  </head>
  <body>
    <div class="page">
      <nav class="nav">
        <a href="/" class="logo" title="Ana sayfaya git">sakla</a>
        <div class="nav-actions">
          <a class="nav-link" href="/admin" title="YÃ¶netim paneline git">YÃ¶netim</a>
        </div>
      </nav>

      <main class="main-content">
        <div class="hero-section">
          <span class="hero-badge">kÄ±sa. akÄ±llÄ±. senin.</span>
          <h1 class="hero-title">KÄ±sa baÄŸlantÄ±larÄ± anÄ±nda oluÅŸturun</h1>
          <p class="hero-subtitle">Her URL'yi saniyeler iÃ§inde temiz ve paylaÅŸÄ±labilir bir baÄŸlantÄ±ya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n</p>
        </div>

        <div class="content-grid">
          <form id="create-form" class="form-card" method="post" action="/api/links" onsubmit="return false;">
            <div class="form-field">
              <label for="target" class="field-label">
                Hedef URL <span class="required">*</span>
              </label>
              <input 
                id="target" 
                name="target" 
                type="url" 
                required 
                placeholder="https://example.com" 
                class="field-input"
              />
            </div>

            <div class="form-row">
              <div class="form-field">
                <label for="alias" class="field-label">
                  Ã–zel KÄ±saltma <span class="optional">isteÄŸe baÄŸlÄ±</span>
                </label>
                <input
                  id="alias"
                  name="alias"
                  type="text"
                  pattern="[a-zA-Z0-9-_]+"
                  placeholder="my-link"
                  class="field-input field-input-mono"
                />
              </div>
              
              <div class="form-field">
                <label for="expiresAt" class="field-label">
                  Son KullanÄ±m <span class="optional">isteÄŸe baÄŸlÄ±</span>
                </label>
                <input 
                  id="expiresAt" 
                  name="expiresAt" 
                  type="datetime-local" 
                  class="field-input"
                />
              </div>
            </div>

            <button type="submit" class="submit-button">
              <span class="material-icons button-icon">add_link</span>
              <span>BaÄŸlantÄ± oluÅŸtur</span>
              <span id="submit-spinner" class="material-icons button-spinner" style="display:none;">hourglass_empty</span>
            </button>
            
            <p id="form-status" class="form-status"></p>
          </form>

          <div id="result-card" class="result-card" data-state="empty">
            <div id="result-placeholder" class="result-placeholder">
              <span class="material-icons placeholder-icon">link</span>
              <p class="placeholder-text">OluÅŸturduÄŸunuz baÄŸlantÄ± burada gÃ¶rÃ¼necek</p>
            </div>
            
            <div id="result-detail" class="result-content" style="display:none;">
              <div class="result-header">
                <span class="material-icons result-icon">check_circle</span>
                <h3 class="result-title">BaÄŸlantÄ± oluÅŸturuldu</h3>
              </div>
              
              <div class="result-url-wrapper">
                <a 
                  id="result-url" 
                  href="#" 
                  target="_blank" 
                  rel="noopener" 
                  class="result-url"
                  title="KÄ±sa baÄŸlantÄ±yÄ± yeni sekmede aÃ§"
                ></a>
              </div>
              
              <div class="result-buttons">
                <button id="copy-link" type="button" class="result-btn result-btn-primary">
                  <span class="material-icons">content_copy</span>
                  BaÄŸlantÄ±yÄ± kopyala
                </button>
                <a 
                  id="qr-link" 
                  href="#" 
                  target="_blank" 
                  rel="noopener"
                  class="result-btn result-btn-secondary"
                  title="Bu baÄŸlantÄ± iÃ§in QR kodunu gÃ¶rÃ¼ntÃ¼le"
                >
                  <span class="material-icons">qr_code</span>
                  QR kodunu gÃ¶r
                </a>
              </div>

              <div class="result-details">
                <div class="detail-item">
                  <span class="detail-label">KÄ±saltma</span>
                  <code id="result-alias" class="detail-value detail-code"></code>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Hedef</span>
                  <span id="result-target" class="detail-value detail-target"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Sona erme</span>
                  <span id="result-expires" class="detail-value"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <section class="bookmarklet-section">
        <div class="bookmarklet-card">
          <div class="bookmarklet-header">
            <span class="material-icons bookmarklet-icon" aria-hidden="true">auto_awesome</span>
            <div>
              <h2 class="bookmarklet-title">Yer Ä°mi AracÄ±</h2>
              <p class="bookmarklet-subtitle">BulunduÄŸunuz sayfayÄ± ayrÄ±lmadan kÄ±saltÄ±n</p>
            </div>
          </div>
          <p class="bookmarklet-copy">
            AÅŸaÄŸÄ±daki dÃ¼ÄŸmeyi yer imi Ã§ubuÄŸunuza sÃ¼rÃ¼kleyin. Herhangi bir sitede tÄ±kladÄ±ÄŸÄ±nÄ±zda sakla aÃ§Ä±lÄ±r ve bulunduÄŸunuz sayfa iÃ§in kÄ±sa baÄŸlantÄ± oluÅŸturur.
          </p>
          <a id="bookmarklet-link" class="bookmarklet-button" href="#" draggable="true">
            <span class="material-icons">bolt</span>
            <span>sakla ile kÄ±salt</span>
          </a>
          <p class="bookmarklet-hint">Ä°pucu: Mobilde butonu favorilerinize ekleyerek elinizin altÄ±nda tutabilirsiniz.</p>
        </div>
      </section>
    </div>

    <Toast />

    <script is:inline>
      console.log('Script loading...');
      (function() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
        
        function init() {
          console.log('DOM loaded');
          const form = document.getElementById('create-form');
          if (!form) {
            console.error('Form not found!');
            return;
          }
          console.log('Form found');
          
          const status = document.getElementById('form-status');
          const spinner = document.getElementById('submit-spinner');
          const detail = document.getElementById('result-detail');
          const card = document.getElementById('result-card');
          const urlAnchor = document.getElementById('result-url');
          const aliasEl = document.getElementById('result-alias');
          const targetEl = document.getElementById('result-target');
          const expiresEl = document.getElementById('result-expires');
          const copyButton = document.getElementById('copy-link');
          const qrLink = document.getElementById('qr-link');
          const bookmarkletLink = document.getElementById('bookmarklet-link');

          console.log('All elements found');

          form.addEventListener('submit', function(e) {
            console.log('SUBMIT EVENT!');
            e.preventDefault();
            e.stopPropagation();
            handleSubmit(e);
            return false;
          });
          
          if (copyButton) {
            copyButton.addEventListener('click', handleCopy);
          }

          if (bookmarkletLink) {
            initializeBookmarklet(bookmarkletLink);
          }

          function initializeBookmarklet(link) {
            try {
              const origin = window.location.origin;
              const isLocal = /^https?:\/\/(localhost|127(?:\.\d+){3})(:\d+)?$/.test(origin);
              const bookmarkletOrigin = isLocal ? origin : "https://sakla.dev";
              const escapedOrigin = bookmarkletOrigin.replace(/'/g, "\\'");
              const bookmarklet = "javascript:(()=>{const base='" + escapedOrigin
                + "';const target=encodeURIComponent(location.href);const win=window.open(base + '/bookmarklet?target=' + target,'_blank');if(win){win.opener=null;}})();";
              link.href = bookmarklet;
            } catch (error) {
              console.error('Failed to set bookmarklet:', error);
              link.removeAttribute('href');
              link.setAttribute('aria-disabled', 'true');
            }
          }

          async function handleSubmit(event) {
            console.log('handleSubmit called', event);
            let formEl = event.target || form;
            
            if (!(formEl instanceof HTMLFormElement)) {
              formEl = document.getElementById('create-form');
              if (!formEl || !(formEl instanceof HTMLFormElement)) {
                console.error('Form element not found');
                setStatus('Error: Form not found');
                return;
              }
            }
            
            console.log('Processing form submission');
            const formData = new FormData(formEl);
            const target = formData.get('target');
            console.log('Target URL:', target);
            
            if (typeof target !== 'string' || target.length === 0) {
              console.log('Target URL is empty');
              setStatus('Hedef URL gerekli.');
              return;
            }
            const alias = formData.get('alias');
            const expiresAt = formData.get('expiresAt');
            const payload = {
              target,
              alias: typeof alias === 'string' && alias.length > 0 ? alias : undefined,
              expiresAt: typeof expiresAt === 'string' && expiresAt.length > 0 ? new Date(expiresAt).toISOString() : undefined,
            };

            console.log('Payload:', payload);
            setSubmitting(true);
            
            try {
              console.log('Sending request to /api/links');
              const response = await fetch('/api/links', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify(payload),
              });

              console.log('Response status:', response.status);
              const result = await response.json();
              console.log('Create link response:', result);
              
              if (!response.ok) {
                const message = typeof result?.error === 'string' ? result.error : 'Failed to create link';
                setStatus(message.replace(/_/g, ' '));
                return;
              }

              if (!result || !result.alias) {
                console.error('Invalid response:', result);
              setStatus('Sunucudan geÃ§ersiz yanÄ±t.');
                return;
              }

              const aliasValue = result.alias;
              const shortUrl = new URL(aliasValue, window.location.origin).toString();
              console.log('Short URL:', shortUrl);
              
              if (urlAnchor) {
                urlAnchor.textContent = shortUrl;
                urlAnchor.href = shortUrl;
                console.log('Updated URL anchor');
              }
              if (aliasEl) {
                aliasEl.textContent = aliasValue;
                console.log('Updated alias:', aliasValue);
              }
              if (targetEl) {
                targetEl.textContent = payload.target;
                console.log('Updated target:', payload.target);
              }
              if (expiresEl) {
                if (payload.expiresAt) {
                  const expiresDate = new Date(payload.expiresAt);
                  expiresEl.textContent = expiresDate.toLocaleString();
                } else {
                  expiresEl.textContent = 'SÃ¼resiz';
                }
              }
              if (qrLink) {
                qrLink.href = '/qr/' + aliasValue;
              }
              
              const placeholder = document.getElementById('result-placeholder');
              if (placeholder) {
                placeholder.style.display = 'none';
                console.log('Hiding placeholder');
              }
              
              if (detail) {
                detail.style.display = '';
                detail.removeAttribute('style');
                console.log('Showing result detail');
              }
              if (card) {
                card.dataset.state = 'ready';
                console.log('Card state set to ready');
              }
              
              setStatus('BaÄŸlantÄ± baÅŸarÄ±yla oluÅŸturuldu!');
              if (formEl) formEl.reset();
            } catch (error) {
              console.error('Error:', error);
              setStatus('Beklenmeyen bir hata oluÅŸtu. Tekrar deneyin.');
            } finally {
              setSubmitting(false);
            }
          }

          function setSubmitting(value) {
            const submit = form.querySelector('button[type="submit"]');
            if (submit instanceof HTMLButtonElement) {
              submit.disabled = value;
              if (value) {
                submit.classList.add('submitting');
              } else {
                submit.classList.remove('submitting');
              }
            }
            if (spinner) spinner.style.display = value ? 'inline-block' : 'none';
          }

          function setStatus(message) {
            if (status) {
              const translated = translateMessage(message);
              status.textContent = translated;
              const normalized = translated.toLowerCase();
              const isError =
                normalized.includes('error') ||
                normalized.includes('hata') ||
                normalized.includes('failed') ||
                normalized.includes('baÅŸarÄ±sÄ±z');
              status.className = isError ? 'form-status form-status-error' : 'form-status';
            }
          }

          function translateMessage(input) {
            const key = (input || '').toString().trim().toLowerCase();
            const map = new Map([
              ['target url is required.', 'Hedef URL gerekli.'],
              ['invalid response from server.', 'Sunucudan geÃ§ersiz yanÄ±t.'],
              ['link created successfully!', 'BaÄŸlantÄ± baÅŸarÄ±yla oluÅŸturuldu!'],
              ['unexpected error. try again.', 'Beklenmeyen bir hata oluÅŸtu. Tekrar deneyin.'],
              ['failed to create link', 'BaÄŸlantÄ± oluÅŸturulamadÄ±'],
              ['invalid target', 'GeÃ§ersiz hedef'],
              ['alias taken', 'KÄ±saltma zaten kullanÄ±mda'],
              ['alias unavailable', 'KÄ±saltma kullanÄ±lamÄ±yor'],
              ['turnstile verification failed', 'Turnstile doÄŸrulamasÄ± baÅŸarÄ±sÄ±z oldu'],
              ['rate limit exceeded', 'Ä°stek sÄ±nÄ±rÄ± aÅŸÄ±ldÄ±'],
              ['short link copied', 'KÄ±sa baÄŸlantÄ± kopyalandÄ±'],
              ['copy failed', 'Kopyalama baÅŸarÄ±sÄ±z'],
              ['error: form not found', 'Hata: Form bulunamadÄ±'],
              ['invalid response from server.', 'Sunucudan geÃ§ersiz yanÄ±t.'],
              ['invalid response from server', 'Sunucudan geÃ§ersiz yanÄ±t'],
            ]);
            return map.get(key) ?? input;
          }

          async function handleCopy() {
            if (!urlAnchor) return;
            const href = urlAnchor.href;
            try {
              await navigator.clipboard.writeText(href);
              if (copyButton) {
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = '<span class="material-icons">check</span> KopyalandÄ±!';
                setTimeout(() => {
                  copyButton.innerHTML = originalText;
                }, 2000);
              }
              window.dispatchEvent(
                new CustomEvent('toast', { detail: { message: 'KÄ±sa baÄŸlantÄ± kopyalandÄ±' } }),
              );
            } catch (error) {
              console.error('Copy failed', error);
              window.dispatchEvent(
                new CustomEvent('toast', { detail: { message: 'Kopyalama baÅŸarÄ±sÄ±z' } }),
              );
            }
          }
        }
      })();
      console.log('Script setup complete');
    </script>
  </body>
</html>

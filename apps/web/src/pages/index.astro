---
import { inlineCSS } from "../styles/inline.css.ts";
import Toast from "../components/Toast.astro";
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>oklinks â€” Launch tactical short links in seconds</title>
    <meta
      name="description"
      content="oklinks is a tactical URL shortener for Cloudflare Pages with D1 persistence, KV caching, and queue-backed analytics."
    />
    <link rel="icon" type="image/svg+xml" href="/oklinks.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style set:html={inlineCSS} is:global></style>
  </head>
  <body>
    <div class="page">
      <nav class="nav">
        <a href="/" class="logo" title="Go to home page">oklinks</a>
        <div class="nav-actions">
          <a class="nav-link" href="/admin" title="Go to admin dashboard">Admin</a>
        </div>
      </nav>

      <main class="main-content">
        <div class="hero-section">
          <div class="hero-content">
            <span class="hero-badge">short. smart. yours.</span>
            <h1 class="hero-title">Create short links instantly</h1>
            <p class="hero-subtitle">Turn any URL into a clean, shareable link in seconds</p>
          </div>
        </div>

        <div class="form-wrapper">
          <form id="create-form" class="form-simple" method="post" action="/api/links" onsubmit="return false;">
            <div class="input-group">
              <label for="target" class="input-label">
                <span class="label-text">Target URL</span>
                <span class="label-required">*</span>
              </label>
              <input 
                id="target" 
                name="target" 
                type="url" 
                required 
                placeholder="https://example.com" 
                class="input-field"
              />
            </div>

            <div class="input-row">
              <div class="input-group">
                <label for="alias" class="input-label">
                  <span class="label-text">Custom Alias</span>
                  <span class="label-optional">optional</span>
                </label>
                <input
                  id="alias"
                  name="alias"
                  type="text"
                  pattern="[a-zA-Z0-9-_]+"
                  placeholder="my-link"
                  class="input-field input-field-mono"
                />
              </div>
              
              <div class="input-group">
                <label for="expiresAt" class="input-label">
                  <span class="label-text">Expiration</span>
                  <span class="label-optional">optional</span>
                </label>
                <input 
                  id="expiresAt" 
                  name="expiresAt" 
                  type="datetime-local" 
                  class="input-field"
                />
              </div>
            </div>

            <button type="submit" class="submit-btn">
              <span class="material-icons btn-icon">add_link</span>
              <span class="btn-text">Create Link</span>
              <span id="submit-spinner" class="material-icons btn-spinner" style="display:none;">hourglass_empty</span>
            </button>
            <p id="form-status" class="form-status"></p>
          </form>

          <div id="result-card" class="result-simple" data-state="empty">
            <div id="result-placeholder" class="result-placeholder">
              <span class="material-icons placeholder-icon">link</span>
              <p class="placeholder-text">Your created link will appear here</p>
            </div>
            
            <div id="result-detail" class="result-detail" style="display:none;">
              <div class="result-header">
                <span class="material-icons result-icon">check_circle</span>
                <h3 class="result-title">Link Created</h3>
              </div>
              
              <div class="result-url-container">
                <a 
                  id="result-url" 
                  href="#" 
                  target="_blank" 
                  rel="noopener" 
                  class="result-url-link"
                  title="Open short link in new tab"
                ></a>
              </div>
              
              <div class="result-actions">
                <button id="copy-link" type="button" class="action-btn action-btn-primary">
                  <span class="material-icons action-icon">content_copy</span>
                  Copy URL
                </button>
                <a 
                  id="qr-link" 
                  href="#" 
                  target="_blank" 
                  rel="noopener"
                  class="action-btn action-btn-secondary"
                  title="View QR code for this link"
                >
                  <span class="material-icons action-icon">qr_code</span>
                  View QR
                </a>
              </div>
              
              <div class="result-info">
                <div class="info-row">
                  <span class="info-label">Alias</span>
                  <code id="result-alias" class="info-value info-value-code"></code>
                </div>
                <div class="info-row">
                  <span class="info-label">Target</span>
                  <span id="result-target" class="info-value info-value-target"></span>
                </div>
                <div class="info-row">
                  <span class="info-label">Expires</span>
                  <span id="result-expires" class="info-value"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <Toast />

    <script is:inline>
      console.log('Script loading...');
      (function() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
        
        function init() {
        console.log('DOM loaded');
        const form = document.getElementById('create-form');
        if (!form) {
          console.error('Form not found!');
          return;
        }
        console.log('Form found');
        
        const status = document.getElementById('form-status');
        const spinner = document.getElementById('submit-spinner');
        const detail = document.getElementById('result-detail');
        const card = document.getElementById('result-card');
        const urlAnchor = document.getElementById('result-url');
        const aliasEl = document.getElementById('result-alias');
        const targetEl = document.getElementById('result-target');
        const expiresEl = document.getElementById('result-expires');
        const copyButton = document.getElementById('copy-link');
        const qrLink = document.getElementById('qr-link');

        console.log('All elements found');

        form.addEventListener('submit', function(e) {
          console.log('SUBMIT EVENT!');
          e.preventDefault();
          e.stopPropagation();
          handleSubmit(e);
          return false;
        });
        
        if (copyButton) {
          copyButton.addEventListener('click', handleCopy);
        }

        async function handleSubmit(event) {
          console.log('handleSubmit called', event);
          let formEl = event.target || form;
          
          if (!(formEl instanceof HTMLFormElement)) {
            formEl = document.getElementById('create-form');
            if (!formEl || !(formEl instanceof HTMLFormElement)) {
              console.error('Form element not found');
              setStatus('Error: Form not found');
              return;
            }
          }
          
          console.log('Processing form submission');
          const formData = new FormData(formEl);
          const target = formData.get('target');
          console.log('Target URL:', target);
          
          if (typeof target !== 'string' || target.length === 0) {
            console.log('Target URL is empty');
            setStatus('Target URL is required.');
            return;
          }
          const alias = formData.get('alias');
          const expiresAt = formData.get('expiresAt');
          const payload = {
            target,
            alias: typeof alias === 'string' && alias.length > 0 ? alias : undefined,
            expiresAt: typeof expiresAt === 'string' && expiresAt.length > 0 ? new Date(expiresAt).toISOString() : undefined,
          };

          console.log('Payload:', payload);
          setSubmitting(true);
          
          try {
            console.log('Sending request to /api/links');
            const response = await fetch('/api/links', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify(payload),
            });

            console.log('Response status:', response.status);
            const result = await response.json();
            console.log('Create link response:', result);
            
            if (!response.ok) {
              const message = typeof result?.error === 'string' ? result.error : 'Failed to create link';
              setStatus(message.replace(/_/g, ' '));
              return;
            }

            if (!result || !result.alias) {
              console.error('Invalid response:', result);
              setStatus('Invalid response from server.');
              return;
            }

            const aliasValue = result.alias;
            const shortUrl = new URL(aliasValue, window.location.origin).toString();
            console.log('Short URL:', shortUrl);
            
            if (urlAnchor) {
              urlAnchor.textContent = shortUrl;
              urlAnchor.href = shortUrl;
              console.log('Updated URL anchor');
            }
            if (aliasEl) {
              aliasEl.textContent = aliasValue;
              console.log('Updated alias:', aliasValue);
            }
            if (targetEl) {
              targetEl.textContent = payload.target;
              console.log('Updated target:', payload.target);
            }
            if (expiresEl) {
              if (payload.expiresAt) {
                const expiresDate = new Date(payload.expiresAt);
                expiresEl.textContent = expiresDate.toLocaleString();
              } else {
                expiresEl.textContent = 'Never';
              }
            }
            if (qrLink) {
              qrLink.href = '/qr/' + aliasValue;
            }
            
            // Hide placeholder and show detail section
            const placeholder = document.getElementById('result-placeholder');
            if (placeholder) {
              placeholder.style.display = 'none';
              console.log('Hiding placeholder');
            } else {
              console.error('Placeholder element not found!');
            }
            
            if (detail) {
              detail.style.display = '';
              detail.removeAttribute('style');
              console.log('Showing result detail');
            } else {
              console.error('Detail element not found!');
            }
            if (card) {
              card.dataset.state = 'ready';
              console.log('Card state set to ready');
            } else {
              console.error('Card element not found!');
            }
            
            setStatus('Link created successfully!');
            if (formEl) formEl.reset();
          } catch (error) {
            console.error('Error:', error);
            setStatus('Unexpected error. Try again.');
          } finally {
            setSubmitting(false);
          }
        }

        function setSubmitting(value) {
          const submit = form.querySelector('button[type="submit"]');
          if (submit instanceof HTMLButtonElement) {
            submit.disabled = value;
            if (value) {
              submit.classList.add('submitting');
            } else {
              submit.classList.remove('submitting');
            }
          }
          if (spinner) spinner.style.display = value ? 'inline-block' : 'none';
        }

        function setStatus(message) {
          if (status) {
            status.textContent = message;
            status.className = message.includes('error') || message.includes('Error') || message.includes('Failed') 
              ? 'form-status form-status-error' 
              : 'form-status';
          }
        }

        async function handleCopy() {
          if (!urlAnchor) return;
          const href = urlAnchor.href;
          try {
            await navigator.clipboard.writeText(href);
            if (copyButton) {
              const originalText = copyButton.innerHTML;
              copyButton.innerHTML = '<span class="material-icons action-icon">check</span> Copied!';
              setTimeout(() => {
                copyButton.innerHTML = originalText;
              }, 2000);
            }
            window.dispatchEvent(
              new CustomEvent('toast', { detail: { message: 'Short link copied' } }),
            );
          } catch (error) {
            console.error('Copy failed', error);
            window.dispatchEvent(
              new CustomEvent('toast', { detail: { message: 'Copy failed' } }),
            );
          }
        }
        } // Close init function
      })();
      console.log('Script setup complete');
    </script>
  </body>
</html>

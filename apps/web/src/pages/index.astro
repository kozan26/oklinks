---
import "../styles/global.css";
import Toast from "../components/Toast.astro";

const siteKey = "";
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>oklinks — Short. Smart. Yours.</title>
    <meta
      name="description"
      content="oklinks is a tactical URL shortener powered by Cloudflare Pages."
    />
    <link rel="icon" type="image/svg+xml" href="/oklinks.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="font-display">
    <div class="relative min-h-screen overflow-hidden">
      <div class="pointer-events-none absolute inset-0 z-0 opacity-70">
        <div class="absolute -left-40 top-24 h-80 w-80 rounded-full bg-accent/20 blur-[120px]"></div>
        <div class="absolute right-0 top-0 h-[32rem] w-[32rem] rounded-full bg-olive/30 blur-[160px]"></div>
      </div>

      <nav class="relative z-10 mx-auto flex w-full max-w-6xl items-center justify-between px-6 pt-8 md:px-8">
        <a href="/" class="flex items-center gap-3 text-lg font-semibold tracking-[0.4em] uppercase text-accent">
          <img src="/oklinks.svg" alt="oklinks logo" class="h-9 w-9 opacity-90" />
          oklinks
        </a>
        <div class="flex items-center gap-3 text-sm">
          <span class="hidden rounded-full border border-white/10 px-3 py-1 text-white/50 md:inline-flex">
            Tactical Noir stack
          </span>
          <a
            href="/admin"
            class="inline-flex items-center gap-2 rounded-full border border-accent/40 px-4 py-2 text-accent transition hover:border-accent/70 hover:bg-accent/10"
          >
            Admin
          </a>
        </div>
      </nav>

      <main class="relative z-10 mx-auto flex w-full max-w-6xl flex-col gap-20 px-6 py-16 md:px-8 md:py-24">
        <header class="flex flex-col gap-6 md:max-w-3xl">
          <span class="inline-flex max-w-max items-center gap-2 rounded-full border border-white/10 bg-graphite/80 px-5 py-2 uppercase tracking-[0.35em] text-[0.65rem] text-accent/80">
            short. smart. yours.
          </span>
          <h1 class="text-4xl font-semibold tracking-tight text-white sm:text-6xl md:text-7xl">
            Launch tactical short links in seconds.
          </h1>
          <p class="text-lg text-accent/70 md:text-xl">
            oklinks runs entirely on Cloudflare Pages with D1, KV, and Workers. Create
            branded redirects, ship QR codes instantly, and keep analytics close to the edge.
          </p>
          <div class="grid gap-4 text-sm text-accent/60 sm:grid-cols-3">
            <div class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 backdrop-blur">
              <span class="text-xs uppercase tracking-[0.3em] text-accent/50">edge ready</span>
              <p class="mt-2 text-white">Pages Functions + D1</p>
            </div>
            <div class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 backdrop-blur">
              <span class="text-xs uppercase tracking-[0.3em] text-accent/50">instant cache</span>
              <p class="mt-2 text-white">KV powered lookups</p>
            </div>
            <div class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 backdrop-blur">
              <span class="text-xs uppercase tracking-[0.3em] text-accent/50">analytics</span>
              <p class="mt-2 text-white">Daily click roll ups</p>
            </div>
          </div>
        </header>

        <section class="grid gap-10 md:grid-cols-[1.6fr_1fr] lg:gap-14">
        <form
          id="create-form"
          class="flex flex-col gap-7 rounded-2xl border border-white/10 bg-white/5 p-8 shadow-2xl shadow-black/50 backdrop-blur-xl ring-1 ring-white/10 md:p-10"
          method="post"
          action="/api/links"
        >
          <div class="flex flex-col gap-3">
            <label for="target" class="text-sm font-medium uppercase tracking-[0.3em] text-accent">
              Target URL
            </label>
            <input
              id="target"
              name="target"
              type="url"
              required
              placeholder="https://example.com/docs"
              class="w-full"
            />
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div class="flex flex-col gap-3">
              <label for="alias" class="text-sm font-medium uppercase tracking-[0.3em] text-accent">
                Custom Alias
              </label>
              <input
                id="alias"
                name="alias"
                type="text"
                pattern="[a-zA-Z0-9-_]+"
                placeholder="optional-code"
                class="w-full font-mono"
              />
              <p class="text-xs text-accent/50 leading-relaxed">
                Allowed: letters, numbers, dashes, underscores.
              </p>
            </div>
            <div class="flex flex-col gap-3">
              <label for="expiresAt" class="text-sm font-medium uppercase tracking-[0.3em] text-accent">
                Expires
              </label>
              <input id="expiresAt" name="expiresAt" type="datetime-local" class="w-full" />
              <p class="text-xs text-accent/50 leading-relaxed">Leave blank to never expire.</p>
            </div>
          </div>

          <div class="flex flex-col gap-4">
            <button
              type="submit"
              class="flex items-center justify-center gap-2 w-full"
            >
              <span>Create link</span>
              <span id="submit-spinner" class="hidden animate-spin text-ink">
                ●
              </span>
            </button>
            <p id="form-status" class="text-sm font-medium text-accent/70 min-h-[1.5rem]"></p>
          </div>
        </form>

        <aside
          id="result-card"
          class="flex h-max flex-col gap-5 rounded-2xl border border-olive/30 bg-graphite/60 backdrop-blur-sm p-7 md:p-8 shadow-xl shadow-black/50 ring-1 ring-white/5 transition-all duration-300"
          data-state="empty"
        >
          <div class="flex flex-col gap-2">
            <h2 class="text-sm font-medium uppercase tracking-[0.3em] text-accent">Latest link</h2>
            <p class="text-xs text-accent/50 leading-relaxed">
              Generated links appear here with quick access actions.
            </p>
          </div>
          <div class="hidden flex-col gap-4" id="result-detail">
            <a
              id="result-url"
              href="#"
              class="text-lg font-semibold text-accent underline decoration-accent/40 underline-offset-4 break-all hover:text-accent/80 transition-colors"
              target="_blank"
              rel="noopener"
            ></a>
            <div class="flex flex-wrap gap-3">
              <button
                id="copy-link"
                type="button"
              >
                Copy URL
              </button>
              <a
                id="qr-link"
                href="#"
                target="_blank"
                rel="noopener"
                class="inline-flex items-center justify-center rounded-lg border border-accent/40 px-4 py-2 text-sm font-semibold text-accent transition-all duration-200 hover:bg-accent/10 hover:border-accent/60"
              >
                View QR
              </a>
            </div>
            <dl class="grid gap-3 pt-2 border-t border-olive/20 text-xs">
              <div class="flex justify-between items-start gap-4">
                <dt class="text-accent/60 font-medium">Alias</dt>
                <dd id="result-alias" class="font-mono text-accent text-right break-all"></dd>
              </div>
              <div class="flex justify-between items-start gap-4">
                <dt class="text-accent/60 font-medium">Target</dt>
                <dd id="result-target" class="truncate text-right text-accent/80 max-w-[200px]"></dd>
              </div>
              <div class="flex justify-between items-start gap-4">
                <dt class="text-accent/60 font-medium">Expires</dt>
                <dd id="result-expires" class="text-right text-accent/80"></dd>
              </div>
            </dl>
          </div>
        </aside>
        </section>

        <section class="grid gap-6 rounded-2xl border border-white/5 bg-white/[0.03] p-8 backdrop-blur xl:grid-cols-3">
          <div class="rounded-2xl border border-white/10 bg-white/[0.04] p-6">
            <h3 class="text-sm uppercase tracking-[0.3em] text-accent/60">Workflow ready</h3>
            <p class="mt-3 text-sm text-accent/70">
              Ship from CLI or the dashboard. Queue processing is optional—D1 updates are already
              batched for you.
            </p>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/[0.04] p-6">
            <h3 class="text-sm uppercase tracking-[0.3em] text-accent/60">Brand-led redirects</h3>
            <p class="mt-3 text-sm text-accent/70">
              Custom aliases, expirations, future password support, and QR badges for every link.
            </p>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/[0.04] p-6">
            <h3 class="text-sm uppercase tracking-[0.3em] text-accent/60">Access controlled</h3>
            <p class="mt-3 text-sm text-accent/70">
              Lock down the admin list with Cloudflare Access. Add audit trails or team workspaces next.
            </p>
          </div>
        </section>
      </main>
    </div>

    <Toast />

    <script is:inline>
      {`(function () {
  const form = document.getElementById('create-form');
  if (!form) return;
  const status = document.getElementById('form-status');
  const spinner = document.getElementById('submit-spinner');
  const detail = document.getElementById('result-detail');
  const card = document.getElementById('result-card');
  const urlAnchor = document.getElementById('result-url');
  const aliasEl = document.getElementById('result-alias');
  const targetEl = document.getElementById('result-target');
  const expiresEl = document.getElementById('result-expires');
  const copyButton = document.getElementById('copy-link');
  const qrLink = document.getElementById('qr-link');

  async function handleSubmit(event) {
    event.preventDefault();
    if (!(event.target instanceof HTMLFormElement)) return;
    const formData = new FormData(event.target);
    const target = formData.get('target');
    if (typeof target !== 'string' || target.length === 0) {
      setStatus('Target URL is required.');
      return;
    }
    const alias = formData.get('alias');
    const expiresAt = formData.get('expiresAt');
    const payload = {
      target,
      alias: typeof alias === 'string' && alias.length > 0 ? alias : undefined,
      expiresAt: typeof expiresAt === 'string' && expiresAt.length > 0 ? new Date(expiresAt).toISOString() : undefined,
    };

    setSubmitting(true);
    try {
      const response = await fetch('/api/links', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const result = await response.json();
      if (!response.ok) {
        const message = typeof result?.error === 'string' ? result.error : 'Failed to create link';
        setStatus(message.replace(/_/g, ' '));
        if (window.turnstile && typeof window.turnstile.reset === 'function') {
          window.turnstile.reset();
        }
        return;
      }

      const aliasValue = result.alias;
      const shortUrl = new URL(aliasValue, window.location.origin).toString();
      if (urlAnchor) {
        urlAnchor.textContent = shortUrl;
        urlAnchor.href = shortUrl;
      }
      if (aliasEl) aliasEl.textContent = aliasValue;
      if (targetEl) targetEl.textContent = payload.target;
      if (expiresEl) {
        if (payload.expiresAt) {
          const expiresDate = new Date(payload.expiresAt);
          expiresEl.textContent = expiresDate.toLocaleString();
        } else {
          expiresEl.textContent = 'Never';
        }
      }
      if (qrLink) {
        qrLink.href = '/qr/' + aliasValue;
      }
      if (detail) detail.classList.remove('hidden');
      if (card) card.dataset.state = 'ready';
      setStatus('Link created.');
      event.target.reset();
      if (window.turnstile && typeof window.turnstile.reset === 'function') {
        window.turnstile.reset();
      }
    } catch (error) {
      console.error(error);
      setStatus('Unexpected error. Try again.');
    } finally {
      setSubmitting(false);
    }
  }

  function setSubmitting(value) {
    const submit = form.querySelector('button[type="submit"]');
    if (submit instanceof HTMLButtonElement) {
      submit.disabled = value;
    }
    if (spinner) spinner.classList.toggle('hidden', !value);
  }

  function setStatus(message) {
    if (status) {
      status.textContent = message;
    }
  }

  async function handleCopy() {
    if (!urlAnchor) return;
    const href = urlAnchor.href;
    try {
      await navigator.clipboard.writeText(href);
      window.dispatchEvent(
        new CustomEvent('toast', { detail: { message: 'Short link copied' } }),
      );
    } catch (error) {
      console.error('Copy failed', error);
      window.dispatchEvent(
        new CustomEvent('toast', { detail: { message: 'Copy failed' } }),
      );
    }
  }

  form.addEventListener('submit', handleSubmit);
  if (copyButton) {
    copyButton.addEventListener('click', handleCopy);
  }
})();`}
    </script>
  </body>
</html>

---
import { inlineCSS } from "../styles/inline.css.ts";
import Toast from "../components/Toast.astro";
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>oklinks — Launch tactical short links in seconds</title>
    <meta
      name="description"
      content="oklinks is a tactical URL shortener for Cloudflare Pages with D1 persistence, KV caching, and queue-backed analytics."
    />
    <link rel="icon" type="image/svg+xml" href="/oklinks.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style set:html={inlineCSS} is:global></style>
  </head>
  <body>
    <div class="page">
      <nav class="nav">
        <a href="/" class="logo">
          <span>oklinks</span>
        </a>
        <div class="nav-actions">
          <a class="outline-button" href="/admin">Admin</a>
        </div>
      </nav>

      <main class="content">
        <section class="main-grid">
          <header class="hero">
            <span class="hero-pill">short. smart. yours.</span>
            <h1 class="hero-title">Launch tactical short links in seconds.</h1>
          </header>

          <form id="create-form" class="card" method="post" action="/api/links">
            <div class="form-grid">
              <div>
                <label for="target">Target URL</label>
                <input id="target" name="target" type="url" required placeholder="https://example.com/docs" />
              </div>

              <div class="two-col">
                <div>
                  <label for="alias">Custom Alias</label>
                  <input
                    id="alias"
                    name="alias"
                    type="text"
                    pattern="[a-zA-Z0-9-_]+"
                    placeholder="optional-code"
                  />
                  <p class="helper-text">Allowed: letters, numbers, dashes, underscores.</p>
                </div>
                <div>
                  <label for="expiresAt">Expires</label>
                  <input id="expiresAt" name="expiresAt" type="datetime-local" />
                  <p class="helper-text">Leave blank to never expire.</p>
                </div>
              </div>

              <p class="helper-text">Anti-abuse challenge is disabled.</p>

              <div>
                <button type="submit" class="primary-button">
                  <span>Create link</span>
                  <span id="submit-spinner" style="display:none;margin-left:0.5rem;">●</span>
                </button>
                <p id="form-status" class="helper-text" style="margin-top:0.75rem;"></p>
              </div>
            </div>
          </form>
        </section>

        <section class="main-grid">
          <aside id="result-card" class="card" data-state="empty">
            <div id="result-placeholder">
              <h2>Latest link</h2>
              <p>Generated links appear here with quick access actions.</p>
            </div>
            <div id="result-detail" style="display:none;">
              <a id="result-url" href="#" target="_blank" rel="noopener" style="display:block;font-size:1.05rem;font-weight:600;word-break:break-all;color:var(--accent);"></a>
              <div class="actions">
                <button id="copy-link" type="button">Copy URL</button>
                <a id="qr-link" href="#" target="_blank" rel="noopener">View QR</a>
              </div>
              <dl class="result-meta">
                <div class="meta-row">
                  <dt>Alias</dt>
                  <dd id="result-alias" class="meta-value meta-value--mono"></dd>
                </div>
                <div class="meta-row">
                  <dt>Target</dt>
                  <dd id="result-target" class="meta-value meta-value--target"></dd>
                </div>
                <div class="meta-row">
                  <dt>Expires</dt>
                  <dd id="result-expires" class="meta-value"></dd>
                </div>
              </dl>
            </div>
          </aside>
        </section>

        <section class="benefits">
          <div class="benefit-card">
            <h3>Workflow ready</h3>
            <p>
              Ship from CLI or the dashboard. Queue processing is optional—D1 updates are already batched for you.
            </p>
          </div>
          <div class="benefit-card">
            <h3>Brand-led redirects</h3>
            <p>Custom aliases, expirations, future password support, and QR badges for every link.</p>
          </div>
          <div class="benefit-card">
            <h3>Access controlled</h3>
            <p>Lock down the admin list with Cloudflare Access. Add audit trails or team workspaces next.</p>
          </div>
        </section>
      </main>
    </div>

    <Toast />

    <script is:inline>
      {`(function () {
  const form = document.getElementById('create-form');
  if (!form) return;
  const status = document.getElementById('form-status');
  const spinner = document.getElementById('submit-spinner');
  const detail = document.getElementById('result-detail');
  const card = document.getElementById('result-card');
  const urlAnchor = document.getElementById('result-url');
  const aliasEl = document.getElementById('result-alias');
  const targetEl = document.getElementById('result-target');
  const expiresEl = document.getElementById('result-expires');
  const copyButton = document.getElementById('copy-link');
  const qrLink = document.getElementById('qr-link');

  form.addEventListener('submit', handleSubmit);
  if (copyButton) {
    copyButton.addEventListener('click', handleCopy);
  }

  async function handleSubmit(event) {
    event.preventDefault();
    if (!(event.target instanceof HTMLFormElement)) return;
    const formData = new FormData(event.target);
    const target = formData.get('target');
    if (typeof target !== 'string' || target.length === 0) {
      setStatus('Target URL is required.');
      return;
    }
    const alias = formData.get('alias');
    const expiresAt = formData.get('expiresAt');
    const payload = {
      target,
      alias: typeof alias === 'string' && alias.length > 0 ? alias : undefined,
      expiresAt: typeof expiresAt === 'string' && expiresAt.length > 0 ? new Date(expiresAt).toISOString() : undefined,
    };

    setSubmitting(true);
    try {
      const response = await fetch('/api/links', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const result = await response.json();
      console.log('Create link response:', result);
      if (!response.ok) {
        const message = typeof result?.error === 'string' ? result.error : 'Failed to create link';
        setStatus(message.replace(/_/g, ' '));
        return;
      }

      if (!result || !result.alias) {
        console.error('Invalid response:', result);
        setStatus('Invalid response from server.');
        return;
      }

      const aliasValue = result.alias;
      const shortUrl = new URL(aliasValue, window.location.origin).toString();
      console.log('Short URL:', shortUrl);
      
      if (urlAnchor) {
        urlAnchor.textContent = shortUrl;
        urlAnchor.href = shortUrl;
        console.log('Updated URL anchor');
      }
      if (aliasEl) {
        aliasEl.textContent = aliasValue;
        console.log('Updated alias:', aliasValue);
      }
      if (targetEl) {
        targetEl.textContent = payload.target;
        console.log('Updated target:', payload.target);
      }
      if (expiresEl) {
        if (payload.expiresAt) {
          const expiresDate = new Date(payload.expiresAt);
          expiresEl.textContent = expiresDate.toLocaleString();
        } else {
          expiresEl.textContent = 'Never';
        }
      }
      if (qrLink) {
        qrLink.href = '/qr/' + aliasValue;
      }
      
      // Hide placeholder and show detail section
      const placeholder = document.getElementById('result-placeholder');
      if (placeholder) {
        placeholder.style.display = 'none';
        console.log('Hiding placeholder');
      }
      
      if (detail) {
        detail.style.display = 'flex';
        detail.style.flexDirection = 'column';
        detail.style.gap = '1rem';
        console.log('Showing result detail');
      }
      if (card) {
        card.dataset.state = 'ready';
        console.log('Card state set to ready');
      }
      
      setStatus('Link created.');
      event.target.reset();
    } catch (error) {
      console.error(error);
      setStatus('Unexpected error. Try again.');
    } finally {
      setSubmitting(false);
    }
  }

  function setSubmitting(value) {
    const submit = form.querySelector('button[type="submit"]');
    if (submit instanceof HTMLButtonElement) {
      submit.disabled = value;
    }
    if (spinner) spinner.style.display = value ? 'inline-block' : 'none';
  }

  function setStatus(message) {
    if (status) {
      status.textContent = message;
    }
  }

  async function handleCopy() {
    if (!urlAnchor) return;
    const href = urlAnchor.href;
    try {
      await navigator.clipboard.writeText(href);
      window.dispatchEvent(
        new CustomEvent('toast', { detail: { message: 'Short link copied' } }),
      );
    } catch (error) {
      console.error('Copy failed', error);
      window.dispatchEvent(
        new CustomEvent('toast', { detail: { message: 'Copy failed' } }),
      );
    }
  }
})();`}
    </script>
  </body>
</html>

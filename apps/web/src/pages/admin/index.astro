---
import { inlineCSS } from "../../styles/inline.css.ts";

// Admin-specific CSS (inline to prevent external CSS file generation)
const adminCSS = `.admin-page {
  min-height: 100vh;
  background: var(--ink);
  background-image:
    radial-gradient(circle at 20% 30%, rgba(67, 213, 255, 0.08) 0%, transparent 55%),
    radial-gradient(circle at 78% 72%, rgba(120, 67, 255, 0.06) 0%, transparent 55%);
  color: var(--text-primary);
  position: relative;
  overflow-x: hidden;
  cursor: default;
}

.admin-page::before,
.admin-page::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 0;
}

.admin-page::before {
  background: radial-gradient(42% 55% at 15% 18%, rgba(67, 213, 255, 0.12), transparent 70%);
}

.admin-page::after {
  background: radial-gradient(35% 55% at 85% 15%, rgba(122, 61, 255, 0.14), transparent 65%);
}

.admin-wrapper {
  display: flex;
  flex-direction: column;
  gap: 2rem;
  max-width: 1080px;
  margin: 0 auto;
  padding: 3rem 2rem 4rem;
  width: 100%;
  position: relative;
  z-index: 1;
}

/* Login */
.auth-screen .main-content {
  padding-top: 4rem;
}

.auth-shell {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 12rem);
  padding: 2rem 0 4rem;
}

.auth-card {
  position: relative;
  width: min(420px, 100%);
  padding: 2.5rem 2.25rem;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface-elevated);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  overflow: hidden;
}

.auth-card::after {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(120% 120% at 15% -20%, rgba(67, 213, 255, 0.22), transparent 55%);
  opacity: 0.6;
  pointer-events: none;
}

.auth-header {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 2rem;
  position: relative;
  z-index: 1;
}

.auth-logo {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2.75rem;
  height: 2.75rem;
  border-radius: 0.9rem;
  background: linear-gradient(135deg, rgba(67, 213, 255, 0.25) 0%, rgba(93, 224, 255, 0.45) 100%);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 1.05rem;
  font-weight: 600;
  box-shadow: 0 10px 24px rgba(67, 213, 255, 0.35);
}

.auth-badge {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  display: inline-block;
  color: var(--accent);
}

.auth-badge + .auth-name {
  display: block;
  margin-top: 0.35rem;
}

.auth-name {
  font-weight: 600;
  font-size: 0.95rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-secondary);
}

.auth-title {
  font-size: clamp(1.9rem, 2vw + 1rem, 2.25rem);
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.01em;
  margin-bottom: 0.5rem;
}

.auth-subtitle {
  color: var(--text-secondary);
  font-size: 0.95rem;
  line-height: 1.5;
  margin-bottom: 1.75rem;
}

.auth-form {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.auth-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.auth-input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  background: rgba(11, 13, 14, 0.55);
  border: 1px solid rgba(67, 213, 255, 0.18);
  border-radius: 0.5rem;
  color: var(--text-primary);
  font-size: 0.95rem;
  transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
}

.auth-input:focus {
  outline: none;
  border-color: rgba(93, 224, 255, 0.65);
  box-shadow: 0 0 0 4px rgba(67, 213, 255, 0.15);
  transform: translateY(-1px);
}

.auth-input::placeholder {
  color: rgba(255, 255, 255, 0.45);
}

.auth-button {
  width: 100%;
  padding: 0.85rem 1rem;
  background: linear-gradient(135deg, rgba(67, 213, 255, 0.9) 0%, rgba(93, 224, 255, 0.6) 100%);
  color: var(--ink);
  border: none;
  border-radius: 0.65rem;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
  box-shadow: 0 14px 30px rgba(67, 213, 255, 0.35);
}

.auth-button:hover:not(:disabled) {
  transform: translateY(-1px);
  filter: brightness(1.05);
}

.auth-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  box-shadow: none;
}

.auth-hint {
  margin-top: 1rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
  text-align: center;
}

.auth-error {
  margin-top: 1rem;
  padding: 0.75rem;
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.25);
  border-radius: 0.375rem;
  color: #ff6b6b;
  font-size: 0.875rem;
}

/* Admin layout */
.admin-shell .main-content {
  padding-top: 2rem;
}

.admin-hero {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  justify-content: space-between;
  gap: 2rem;
  padding: clamp(2.25rem, 3vw + 1rem, 2.75rem);
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface-elevated);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  position: relative;
  overflow: hidden;
}

.admin-hero::after {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(75% 75% at 100% 0%, rgba(67, 213, 255, 0.18), transparent 60%);
  pointer-events: none;
}

.admin-hero-copy {
  position: relative;
  z-index: 1;
  max-width: 520px;
}

.admin-hero-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.45rem;
  padding: 0.35rem 0.75rem;
  border-radius: 999px;
  background: rgba(67, 213, 255, 0.12);
  border: 1px solid rgba(67, 213, 255, 0.22);
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 1.25rem;
}

.admin-hero-title {
  font-size: clamp(2rem, 3vw + 1rem, 2.6rem);
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.02em;
  margin: 0 0 1rem;
  line-height: 1.1;
}

.admin-hero-description {
  color: var(--text-secondary);
  font-size: 0.95rem;
  line-height: 1.7;
}

.admin-hero-meta {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.75rem;
  min-width: 180px;
}

.sync-label {
  margin: 0;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1.5rem;
}

.metric-card {
  background: rgba(11, 13, 14, 0.6);
  border: 1px solid rgba(67, 213, 255, 0.18);
  border-radius: 20px;
  padding: 2rem;
  position: relative;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

.metric-card::after {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(110% 110% at 20% 10%, rgba(67, 213, 255, 0.22), transparent 60%);
  pointer-events: none;
}

.metric-label {
  color: var(--text-secondary);
  font-size: 0.78rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.metric-value {
  margin-top: 0.75rem;
  font-size: 1.9rem;
  font-weight: 600;
  letter-spacing: -0.02em;
}

.metric-footnote {
  margin-top: 0.75rem;
  font-size: 0.78rem;
  color: rgba(255, 255, 255, 0.6);
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.metric-chip {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.3rem 0.6rem;
  border-radius: 999px;
  background: rgba(67, 213, 255, 0.18);
  color: var(--accent);
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.table-card {
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface-elevated);
  padding: 2.25rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

.table-head {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.table-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
}

.table-subtitle {
  margin-top: 0.35rem;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.table-scroll {
  overflow-x: auto;
  border-radius: 0.875rem;
  border: 1px solid rgba(67, 213, 255, 0.18);
  background: rgba(11, 13, 14, 0.55);
  box-shadow:
    inset 0 2px 4px rgba(0, 0, 0, 0.2),
    inset 0 0 0 1px rgba(67, 213, 255, 0.1);
}

.admin-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.9rem;
}

.admin-table th,
.admin-table td {
  padding: 0.85rem 1rem;
  text-align: left;
  border-bottom: 1px solid rgba(67, 213, 255, 0.08);
}

.admin-table th {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-secondary);
  background: rgba(67, 213, 255, 0.05);
}

.admin-table tbody tr:last-child td {
  border-bottom: none;
}

.admin-table tbody tr:nth-child(odd) {
  background: rgba(10, 12, 13, 0.35);
}

.admin-table tbody tr:hover {
  background: rgba(67, 213, 255, 0.08);
}

.link-target {
  max-width: 360px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.link-target-anchor {
  color: var(--text-secondary);
}

.link-target-anchor:hover {
  color: var(--accent);
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.35rem 0.75rem;
  border-radius: 999px;
  font-size: 0.8rem;
  background: rgba(67, 213, 255, 0.12);
  color: var(--accent);
}

.badge-mono {
  font-family: var(--font-mono);
  font-size: 0.78rem;
}

.button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.6rem 1.1rem;
  border-radius: 0.65rem;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s, background 0.2s, color 0.2s;
  border: none;
  font-family: inherit;
  color: var(--text-primary);
}

.button-secondary {
  background: rgba(67, 213, 255, 0.18);
  border: 1px solid rgba(67, 213, 255, 0.3);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.button-secondary:hover:not(:disabled) {
  transform: translateY(-1px);
  background: rgba(67, 213, 255, 0.25);
  border-color: rgba(67, 213, 255, 0.5);
}

.button:disabled {
  opacity: 0.45;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.button-destructive {
  background: rgba(255, 107, 107, 0.15);
  border: 1px solid rgba(255, 107, 107, 0.25);
  color: #ff6b6b;
}

.button-destructive:hover:not(:disabled) {
  transform: translateY(-1px);
  background: rgba(255, 107, 107, 0.25);
  border-color: rgba(255, 107, 107, 0.35);
}

.button-icon {
  font-size: 1rem;
}

.admin-status {
  margin-bottom: 1.25rem;
  padding: 0.85rem 1rem;
  border-radius: 0.75rem;
  background: rgba(11, 13, 14, 0.65);
  border: 1px solid rgba(67, 213, 255, 0.18);
  color: var(--text-secondary);
  font-size: 0.85rem;
  text-align: center;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.admin-status.error-state {
  background: rgba(255, 107, 107, 0.1);
  border-color: rgba(255, 107, 107, 0.25);
  color: #ff8989;
}

.table-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.25rem 0.6rem;
  border-radius: 999px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.table-pill.never {
  background: rgba(67, 213, 255, 0.12);
  color: var(--accent);
}

.table-pill.warning {
  background: rgba(255, 188, 66, 0.18);
  color: #ffbc42;
}

.table-pill.active {
  background: rgba(72, 207, 173, 0.16);
  color: #48cfad;
}

.table-pill.expired {
  background: rgba(255, 107, 107, 0.18);
  color: #ff6b6b;
}

.empty-state,
.error-state {
  text-align: center;
  padding: 2.5rem 1rem;
  color: var(--text-secondary);
}

.error-state {
  color: #ff6b6b;
}

@media (max-width: 960px) {
  .admin-hero {
    flex-direction: column;
    align-items: flex-start;
  }

  .admin-hero-meta {
    width: 100%;
    align-items: flex-start;
  }
}

@media (max-width: 768px) {
  .admin-wrapper {
    padding: 2.5rem 1.5rem 3rem;
  }

  .auth-card {
    padding: 2.25rem 1.75rem;
  }

  .metrics-grid {
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
  }

  .table-card {
    padding: 1.5rem;
  }

  .admin-table {
    font-size: 0.82rem;
  }

  .admin-table th,
  .admin-table td {
    padding: 0.65rem 0.8rem;
  }
}`;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>sakla â€” Admin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”—</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style set:html={inlineCSS} is:global></style>
    <style set:html={adminCSS} is:global></style>
  </head>
  <body class="admin-page" style="cursor: default;">
    <div class="page">
      <nav class="nav">
        <a href="/" class="logo" title="Ana sayfaya git">sakla.dev</a>
        <div class="nav-actions">
          <a class="nav-link" href="/" title="Ana sayfaya git">Ana sayfa</a>
        </div>
      </nav>

      <div id="login-screen" class="auth-screen" style="display: none;">
        <main class="main-content">
          <div class="auth-shell">
            <section class="auth-card">
              <div class="auth-header">
                <span class="auth-logo">sa</span>
                <div>
                  <span class="auth-badge">YÃ¶netim Konsolu</span>
                  <span class="auth-name">sakla.dev</span>
                </div>
              </div>
              <h1 class="auth-title">Tekrar hoÅŸ geldiniz</h1>
              <p class="auth-subtitle">YÃ¶netim paneline eriÅŸmek iÃ§in ÅŸifrenizi girin.</p>
              <form id="login-form" class="auth-form">
                <div>
                  <label for="admin-password" class="auth-label">Åžifre</label>
                  <input
                    id="admin-password"
                    type="password"
                    class="auth-input"
                    placeholder="YÃ¶netici ÅŸifresini girin"
                    required
                    autocomplete="current-password"
                  />
                </div>
                <button type="submit" class="auth-button" id="login-button">
                  GiriÅŸ yap
                </button>
                <p class="auth-hint">Cloudflare Access ile korunur Â· Bu sekmeyi kapattÄ±ÄŸÄ±nÄ±zda oturum sÄ±fÄ±rlanÄ±r</p>
                <div id="login-error" class="auth-error" style="display: none;"></div>
              </form>
            </section>
          </div>
        </main>
      </div>

      <div id="admin-content" class="admin-shell" style="display: none;">
        <main class="main-content">
          <div class="admin-wrapper">
            <header class="admin-hero">
              <div class="admin-hero-copy">
                <span class="admin-hero-badge">
                  <span class="material-icons button-icon" aria-hidden="true">bolt</span>
                  BaÄŸlantÄ± Operasyon Merkezi
                </span>
                <h1 class="admin-hero-title">BaÄŸlantÄ± panosu</h1>
                <p class="admin-hero-description">
                  PerformansÄ± izleyin, eskimiÅŸ yÃ¶nlendirmeleri temizleyin ve kÄ±sa baÄŸlantÄ±larÄ±nÄ±zÄ± formda tutun.
                </p>
              </div>
              <div class="admin-hero-meta">
                <button id="refresh" type="button" class="button button-secondary">
                  <span class="material-icons button-icon" aria-hidden="true">refresh</span>
                  Verileri yenile
                </button>
                <span class="sync-label">Son senkronizasyon <span id="last-refresh">hiÃ§</span></span>
              </div>
            </header>

            <section id="admin-metrics" class="metrics-grid"></section>

            <section class="table-card">
              <div class="table-head">
                <div>
                  <h2 class="table-title">Son baÄŸlantÄ±lar</h2>
                  <p class="table-subtitle">OluÅŸturulma tarihine gÃ¶re sÄ±ralanan son 50 kaydÄ± gÃ¶steriyoruz</p>
                </div>
              </div>

              <div id="admin-status" class="admin-status" style="display: none;"></div>

              <div class="table-scroll">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>KÄ±saltma</th>
                      <th>Hedef</th>
                      <th>TÄ±klama</th>
                      <th>Sona erme</th>
                      <th>Ä°ÅŸlemler</th>
                    </tr>
                  </thead>
                  <tbody id="links-body"></tbody>
                </table>
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>

<script is:inline>
      console.log('Admin script loading...');
      (function() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
        
        function init() {
          const loginScreen = document.getElementById('login-screen');
          const adminContent = document.getElementById('admin-content');
          const loginForm = document.getElementById('login-form');
          const loginError = document.getElementById('login-error');
          const loginButton = document.getElementById('login-button');
          const passwordInput = document.getElementById('admin-password');
          const status = document.getElementById('admin-status');
          const body = document.getElementById('links-body');
          const refresh = document.getElementById('refresh');

          // Check if already authenticated
          const token = sessionStorage.getItem('admin_token');
          if (token) {
            verifyToken(token);
          } else {
            showLogin();
          }

          if (loginForm) {
            loginForm.addEventListener('submit', handleLogin);
          }

          async function handleLogin(e) {
            e.preventDefault();
            if (!passwordInput) return;

            const password = passwordInput.value;
            if (!password) return;

            if (loginButton) {
              loginButton.disabled = true;
              loginButton.textContent = 'GiriÅŸ yapÄ±lÄ±yor...';
            }

            try {
              const response = await fetch('/api/admin-auth', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ password }),
              });

              const data = await response.json();

              if (!response.ok) {
                showError(data.error === 'invalid_password' ? 'Åžifre yanlÄ±ÅŸ. LÃ¼tfen tekrar deneyin.' : 'Kimlik doÄŸrulamasÄ± baÅŸarÄ±sÄ±z oldu');
                if (loginButton) {
                  loginButton.disabled = false;
                  loginButton.textContent = 'GiriÅŸ yap';
                }
                return;
              }

              if (data.token) {
                sessionStorage.setItem('admin_token', data.token);
                showAdmin();
                loadLinks();
              }
            } catch (error) {
              console.error('Login error:', error);
              showError('Kimlik doÄŸrulamasÄ± baÅŸarÄ±sÄ±z oldu. LÃ¼tfen tekrar deneyin.');
              if (loginButton) {
                loginButton.disabled = false;
                loginButton.textContent = 'GiriÅŸ yap';
              }
            }
          }

          async function verifyToken(token) {
            try {
              const response = await fetch('/api/admin-auth', {
                headers: { 'Authorization': `Bearer ${token}` },
              });

              const data = await response.json();
              if (data.authenticated) {
                showAdmin();
                loadLinks();
              } else {
                sessionStorage.removeItem('admin_token');
                showLogin();
              }
            } catch (error) {
              console.error('Token verification error:', error);
              sessionStorage.removeItem('admin_token');
              showLogin();
            }
          }

          function showLogin() {
            if (loginScreen) loginScreen.style.display = '';
            if (adminContent) adminContent.style.display = 'none';
            if (passwordInput) passwordInput.value = '';
            if (loginError) loginError.style.display = 'none';
          }

          function showAdmin() {
            if (loginScreen) loginScreen.style.display = 'none';
            if (adminContent) adminContent.style.display = '';
            if (loginError) loginError.style.display = 'none';
          }

          function showError(message) {
            if (loginError) {
              loginError.textContent = message;
              loginError.style.display = '';
            }
          }

          function setStatus(message, isError = false) {
            if (status) {
              const translated = translateStatusMessage(message);
              status.textContent = translated;
              status.style.display = translated ? 'block' : 'none';
              const normalized = translated.toLowerCase();
              const autoError =
                normalized.includes('hata') ||
                normalized.includes('error') ||
                normalized.includes('baÅŸarÄ±sÄ±z');
              status.className = isError || autoError ? 'admin-status error-state' : 'admin-status';
            }
          }

          function translateStatusMessage(input) {
            const original = (input ?? '').toString();
            const key = original.trim().toLowerCase();
            if (!key) return original;
            const map = new Map([
              ['loading links...', 'BaÄŸlantÄ±lar yÃ¼kleniyor...'],
              ['no links found.', 'BaÄŸlantÄ± bulunamadÄ±.'],
              ['no links found', 'BaÄŸlantÄ± bulunamadÄ±'],
              ['no links created yet.', 'HenÃ¼z baÄŸlantÄ± oluÅŸturulmadÄ±.'],
              ['link deleted successfully.', 'BaÄŸlantÄ± baÅŸarÄ±yla silindi.'],
              ['failed to load links', 'BaÄŸlantÄ±lar yÃ¼klenemedi'],
              ['failed to load metrics', 'Metrikler yÃ¼klenemedi'],
              ['error: link id not found', 'Hata: BaÄŸlantÄ± kimliÄŸi bulunamadÄ±'],
              ['failed to delete link', 'BaÄŸlantÄ± silinemedi'],
              ['server returned empty response', 'Sunucu boÅŸ yanÄ±t dÃ¶ndÃ¼rdÃ¼'],
              ['server returned non-json response', 'Sunucu JSON olmayan bir yanÄ±t dÃ¶ndÃ¼rdÃ¼'],
              ['the delete endpoint was not found. the route may not be configured correctly.', 'Silme uÃ§ noktasÄ± bulunamadÄ±. Rota doÄŸru yapÄ±landÄ±rÄ±lmamÄ±ÅŸ olabilir.'],
              ['delete was not successful', 'Silme iÅŸlemi baÅŸarÄ±lÄ± olmadÄ±'],
              ['unknown error', 'Bilinmeyen hata'],
            ]);
            if (map.has(key)) {
              return map.get(key) ?? original;
            }
            if (key.startsWith('request failed')) {
              return original.replace(/request failed/i, 'Ä°stek baÅŸarÄ±sÄ±z');
            }
            if (key.startsWith('server returned non-json response')) {
              return original.replace(/Server returned non-JSON response/i, 'Sunucu JSON olmayan bir yanÄ±t dÃ¶ndÃ¼rdÃ¼');
            }
            return original;
          }

          const metrics = document.getElementById('admin-metrics');
          const lastRefreshDisplay = document.getElementById('last-refresh');
          const numberFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
          const averageFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 1 });
          const timeFormatter = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' });
          const formatInteger = (value) =>
            numberFormatter.format(Math.max(0, Math.round(Number(value) || 0)));
          const formatAverage = (value) =>
            averageFormatter.format(Math.max(0, Number(value) || 0));
          const refreshDefaultHTML = refresh ? refresh.innerHTML : '';

          async function loadLinks() {
            const token = sessionStorage.getItem('admin_token');
            if (!token) {
              showLogin();
              return;
            }

            setStatus('BaÄŸlantÄ±lar yÃ¼kleniyor...');
            if (body) body.innerHTML = '';
            if (metrics) {
              metrics.innerHTML = `
                <article class="metric-card">
                  <div class="metric-label">Pano</div>
                  <div class="metric-value">...</div>
                  <div class="metric-footnote">Son istatistikler alÄ±nÄ±yor</div>
                </article>`;
            }
            if (refresh) {
              if (!refresh.dataset.originalContent) {
                refresh.dataset.originalContent = refresh.innerHTML;
              }
              refresh.disabled = true;
              refresh.innerHTML = '<span class="material-icons" style="font-size: 1rem;">hourglass_top</span> GÃ¼ncelleniyor...';
            }
            if (lastRefreshDisplay) {
              lastRefreshDisplay.textContent = 'gÃ¼ncelleniyor...';
            }

            try {
              const response = await fetch('/api/links', {
                headers: {
                  accept: 'application/json',
                },
              });
              
              if (!response.ok) {
                if (response.status === 401) {
                  sessionStorage.removeItem('admin_token');
                  showLogin();
                  return;
                }
                const errorText = await response.text();
                console.error('API error:', response.status, errorText);
                throw new Error('Request failed: ' + response.status);
              }
              
              const payload = await response.json();
              console.log('API response:', payload);
              const items = Array.isArray(payload?.links) ? payload.links : [];
              const stats = typeof payload?.stats === 'object' && payload.stats !== null ? payload.stats : null;
              console.log('Links found:', items.length);

              const normalizeNumber = (value, fallback) => {
                const numberValue = typeof value === 'number' ? value : Number(value);
                return Number.isFinite(numberValue) ? numberValue : fallback;
              };

              const nowSeconds = Math.floor(Date.now() / 1000);
              const fallbackProtected = items.filter((link) => Boolean(link?.password_hash)).length;
              const fallbackLive = items.filter((link) => {
                const isActive = Number(link?.is_active) === 1;
                const expires = Number(link?.expires_at);
                const hasExpired = Number.isFinite(expires) && expires > 0 && expires <= nowSeconds;
                return isActive && !hasExpired;
              }).length;
              const fallbackExpired = items.filter((link) => {
                const expires = Number(link?.expires_at);
                return Number.isFinite(expires) && expires > 0 && expires <= nowSeconds;
              }).length;
              const fallbackInactive = items.filter((link) => Number(link?.is_active) === 0).length;
              const fallbackSoonExpiring = items.filter((link) => {
                const expires = Number(link?.expires_at);
                return (
                  Number.isFinite(expires) &&
                  expires > nowSeconds &&
                  expires <= nowSeconds + 7 * 24 * 60 * 60
                );
              }).length;
              const fallbackClicks = items.reduce(
                (sum, link) => sum + (Number(link?.clicks_total) || 0),
                0,
              );

              const totalLinks = normalizeNumber(stats?.total, items.length);
              const protectedCount = normalizeNumber(stats?.protected, fallbackProtected);
              const liveCount = normalizeNumber(stats?.live, fallbackLive);
              const expiredCount = normalizeNumber(stats?.expired, fallbackExpired);
              const inactiveCount = normalizeNumber(stats?.inactive, fallbackInactive);
              const soonExpiringCount = normalizeNumber(stats?.expiringSoon, fallbackSoonExpiring);
              const totalClicks = normalizeNumber(stats?.totalClicks, fallbackClicks);
              const averageClicks = totalLinks > 0 ? totalClicks / totalLinks : 0;
              const publicCount = Math.max(totalLinks - protectedCount, 0);
              const pausedCount = Math.max(totalLinks - liveCount, 0);
              const newestLink = items[0];

              if (metrics) {
                const latestSummary = escapeHtml(
                  newestLink && (newestLink.alias || newestLink.id)
                    ? `En yeni: ${newestLink.alias || newestLink.id}`
                    : 'En yeni: yok',
                );
                const metricsCards = [
                  {
                    label: 'Toplam baÄŸlantÄ±',
                    value: formatInteger(totalLinks),
                    footnote: totalLinks
                      ? `<span class="metric-chip">${formatInteger(protectedCount)} korumalÄ±</span><span>${formatInteger(publicCount)} herkese aÃ§Ä±k</span>`
                      : 'Bu panoyu doldurmak iÃ§in ilk kÄ±sa baÄŸlantÄ±nÄ±zÄ± oluÅŸturun.',
                  },
                  {
                    label: 'Aktif baÄŸlantÄ±lar',
                    value: formatInteger(liveCount),
                    footnote: liveCount
                      ? `<span class="metric-chip">${formatInteger(soonExpiringCount)} yakÄ±nda sona erecek</span><span>${formatInteger(pausedCount)} durduruldu</span>`
                      : 'Åžu anda aktif baÄŸlantÄ± yok.',
                  },
                  {
                    label: 'SÃ¼resi dolmuÅŸ / pasif',
                    value: formatInteger(expiredCount + inactiveCount),
                    footnote: expiredCount + inactiveCount
                      ? `<span class="metric-chip">${formatInteger(expiredCount)} sÃ¼resi dolmuÅŸ</span><span>${formatInteger(inactiveCount)} devre dÄ±ÅŸÄ±</span>`
                      : 'Her ÅŸey yolunda - sÃ¼resi dolan yok.',
                  },
                  {
                    label: 'Toplam tÄ±klama',
                    value: formatInteger(totalClicks),
                    footnote: totalClicks
                      ? `<span class="metric-chip">${formatAverage(averageClicks)} ort</span><span>baÄŸlantÄ± baÅŸÄ±na</span><span>${latestSummary}</span>`
                      : 'HenÃ¼z trafik kaydedilmedi.',
                  },
                ];

                metrics.innerHTML = metricsCards
                  .map(
                    (card) => `
                      <article class="metric-card">
                        <div class="metric-label">${card.label}</div>
                        <div class="metric-value">${card.value}</div>
                        <div class="metric-footnote">${card.footnote}</div>
                      </article>`,
                  )
                  .join('');
              }
              
              if (items.length === 0) {
                setStatus('BaÄŸlantÄ± bulunamadÄ±.');
                if (body) {
                  body.innerHTML = '<tr><td colspan="5" class="empty-state">HenÃ¼z baÄŸlantÄ± oluÅŸturulmadÄ±.</td></tr>';
                }
                if (lastRefreshDisplay) {
                  lastRefreshDisplay.textContent = timeFormatter.format(new Date());
                }
                return;
              }

              const fragment = document.createDocumentFragment();
              for (const link of items) {
                const row = document.createElement('tr');
                const safeAlias = escapeHtml(link.alias || '');
                const safeId = escapeHtml(link.id || '');
                const safeTarget = escapeHtml(link.target || '');
                const safeTargetHref = escapeHtml(link.target || '');
                const clicksDisplay = formatInteger(link.clicks_total ?? 0);
                const aliasSlug = link.alias || link.id || '';
                const aliasHref = aliasSlug ? '/' + encodeURIComponent(aliasSlug) : null;
                const aliasCell = aliasHref
                  ? `<a href="${aliasHref}" class="badge badge-mono" target="_blank" rel="noopener">${safeAlias || safeId}</a>`
                  : `<span class="badge badge-mono">${safeAlias || safeId}</span>`;
                row.innerHTML = `
                  <td>${aliasCell}</td>
                  <td class="link-target" title="${safeTarget}">
                    ${
                      safeTarget
                        ? `<a href="${safeTargetHref}" target="_blank" rel="noopener" class="link-target-anchor">${safeTarget}</a>`
                        : 'â€”'
                    }
                  </td>
                  <td style="text-align: right;">${clicksDisplay}</td>
                  <td style="text-align: right;">${formatExpiry(link.expires_at)}</td>
                  <td style="text-align: right;">
                    <button data-id="${safeId}" class="button button-destructive delete-btn">
                      <span class="material-icons" style="font-size: 1rem;">delete</span>
                      Sil
                    </button>
                  </td>`;
                fragment.appendChild(row);
              }

              if (body) {
                body.appendChild(fragment);
              }
              
              setStatus(`${items.length} baÄŸlantÄ± yÃ¼klendi.`);
              if (lastRefreshDisplay) {
                lastRefreshDisplay.textContent = timeFormatter.format(new Date());
              }
            } catch (error) {
              console.error('Load error:', error);
              setStatus('BaÄŸlantÄ±lar yÃ¼klenemedi: ' + (error.message || 'Bilinmeyen hata'), true);
              if (body) {
                body.innerHTML = '<tr><td colspan="5" class="error-state">BaÄŸlantÄ±lar yÃ¼klenirken hata oluÅŸtu. AyrÄ±ntÄ±lar iÃ§in konsolu kontrol edin.</td></tr>';
              }
              if (metrics) {
                const message = escapeHtml(error?.message || 'Metrikler yÃ¼klenemedi');
                metrics.innerHTML = `
                  <article class="metric-card">
                    <div class="metric-label">Hata</div>
                    <div class="metric-value">!</div>
                    <div class="metric-footnote">${message}</div>
                  </article>`;
              }
              if (lastRefreshDisplay) {
                lastRefreshDisplay.textContent = 'baÅŸarÄ±sÄ±z';
              }
            } finally {
              if (refresh) {
                refresh.disabled = false;
                refresh.innerHTML = refresh.dataset.originalContent || refreshDefaultHTML || 'Yenile';
              }
            }
          }

          function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          }

          function formatExpiry(expires) {
            if (!expires) {
              return '<span class="table-pill never">SÃ¼resiz</span>';
            }
            const value = Number(expires);
            if (!Number.isFinite(value) || value <= 0) {
              return '<span class="table-pill never">SÃ¼resiz</span>';
            }
            const date = new Date(value * 1000);
            const now = Date.now();
            const formattedDate = escapeHtml(date.toLocaleString());
            if (date.getTime() < now) {
              return `${formattedDate} <span class="table-pill expired">SÃ¼resi doldu</span>`;
            }
            const diffMs = date.getTime() - now;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);
            if (diffDays <= 7) {
              const daysRemaining = Math.max(1, Math.ceil(diffDays));
              return `${formattedDate} <span class="table-pill warning">${daysRemaining} gÃ¼n iÃ§inde</span>`;
            }
            return `${formattedDate} <span class="table-pill active">Aktif</span>`;
          }

          async function handleDelete(event) {
            const token = sessionStorage.getItem('admin_token');
            if (!token) {
              showLogin();
              return;
            }

            const target = event.target.closest('.delete-btn');
            if (!target) return;
            
            const id = target.getAttribute('data-id');
            if (!id) {
              console.error('Delete failed: no ID found');
              setStatus('Hata: BaÄŸlantÄ± kimliÄŸi bulunamadÄ±', true);
              return;
            }
            
            if (!confirm('Bu baÄŸlantÄ±yÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) {
              return;
            }

            target.disabled = true;
            const originalHTML = target.innerHTML;
            target.innerHTML = '<span class="material-icons" style="font-size: 1rem;">hourglass_empty</span> Siliniyor...';
            
            try {
              console.log('Deleting link:', id);
              const url = '/api/links/' + encodeURIComponent(id);
              console.log('Delete URL:', url);
              
              const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                  'accept': 'application/json',
                },
              });
              
              console.log('Delete response status:', response.status);
              console.log('Delete response headers:', Object.fromEntries(response.headers.entries()));
              
              const contentType = response.headers.get('content-type') || '';
              console.log('Content-Type:', contentType);
              
              let result;
              const responseText = await response.text();
              console.log('Raw response text (first 500 chars):', responseText.substring(0, 500));
              console.log('Response text length:', responseText.length);
              
              // Try to parse as JSON
              if (responseText.trim()) {
                try {
                  result = JSON.parse(responseText);
                  console.log('Successfully parsed JSON:', result);
                } catch (parseError) {
                  console.error('Failed to parse as JSON:', parseError);
                  console.error('Response text:', responseText);
                  
                  // If it's HTML (404 page or error), provide better error
                  if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
                    result = { 
                      error: 'route_not_found', 
                      deleted: false,
                      message: 'Silme uÃ§ noktasÄ± bulunamadÄ±. Rota doÄŸru yapÄ±landÄ±rÄ±lmamÄ±ÅŸ olabilir.',
                      status: response.status
                    };
                  } else {
                    result = { 
                      error: 'invalid_response', 
                      deleted: false,
                      message: 'Sunucu JSON olmayan bir yanÄ±t dÃ¶ndÃ¼rdÃ¼: ' + responseText.substring(0, 200),
                      raw: responseText.substring(0, 200)
                    };
                  }
                }
              } else {
                result = { error: 'empty_response', deleted: false, message: 'Sunucu boÅŸ yanÄ±t dÃ¶ndÃ¼rdÃ¼' };
              }
              
              console.log('Parsed result:', result);
              
              if (!response.ok) {
                if (response.status === 401) {
                  sessionStorage.removeItem('admin_token');
                  showLogin();
                  return;
                }
                throw new Error(result.error || result.message || `Silme baÅŸarÄ±sÄ±z (${response.status})`);
              }
              
              if (result.deleted === true) {
                setStatus('BaÄŸlantÄ± baÅŸarÄ±yla silindi.');
                setTimeout(() => setStatus(''), 3000);
                await loadLinks();
              } else {
                throw new Error(result.error || result.message || 'Silme iÅŸlemi baÅŸarÄ±lÄ± olmadÄ±');
              }
            } catch (error) {
              console.error('Delete error:', error);
              setStatus('BaÄŸlantÄ± silinemedi: ' + (error.message || 'Bilinmeyen hata'), true);
              target.innerHTML = originalHTML;
              target.disabled = false;
            }
          }

          if (refresh) {
            refresh.addEventListener('click', loadLinks);
          }

          if (body) {
            body.addEventListener('click', handleDelete);
          }
        }
      })();
      console.log('Admin script setup complete');
    </script>
  </body>
</html>
